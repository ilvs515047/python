<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python å­¸ç¿’å„€è¡¨æ¿</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.11.0/brython.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.11.0/brython_stdlib.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: #f0f2f5; }
        .container { display: flex; height: 100vh; }
        
        /* é€šç”¨å€å¡Šæ¨£å¼ */
        .column { padding: 20px; box-sizing: border-box; overflow-y: auto; border-right: 1px solid #ddd; }
        h2 { font-size: 1.2rem; color: #333; margin-top: 0; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; display: inline-block;}

        /* å·¦é‚Šï¼šå¤§ç¶± */
        .left { width: 25%; background: #fff; }
        .chapter { font-weight: bold; margin-top: 15px; color: #555; }
        .topic-item { display: flex; align-items: center; padding: 8px 0; cursor: pointer; transition: 0.2s; }
        .topic-item:hover { background: #f9f9f9; }
        .topic-item.active { background: #e3f2fd; font-weight: bold; }
        .topic-item input { margin-right: 10px; transform: scale(1.2); cursor: pointer; }

        /* ä¸­é–“ï¼šAIèˆ‡å¿ƒå¾— */
        .center { width: 35%; background: #fcfcfc; display: flex; flex-direction: column; }
        .chat-box { flex: 1; border: 1px solid #ddd; border-radius: 8px; background: #fff; padding: 15px; margin-bottom: 15px; overflow-y: auto; }
        .note-area { height: 150px; width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #ccc; border-radius: 5px; resize: vertical; margin-bottom: 10px; }
        .btn { background: #4CAF50; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; font-size: 0.9rem; }
        .btn:hover { background: #45a049; }
        .ai-msg { background: #e8f5e9; padding: 8px; border-radius: 8px; margin: 5px 0; }
        .user-msg { background: #e3f2fd; padding: 8px; border-radius: 8px; margin: 5px 0; text-align: right; }

        /* å³é‚Šï¼šç·¨è­¯å™¨ */
        .right { width: 40%; background: #1e1e1e; color: #d4d4d4; display: flex; flex-direction: column; }
        .right h2 { color: #ddd; border-bottom-color: #007acc; }
        #editor { flex: 1; background: #252526; color: #d4d4d4; border: 1px solid #333; padding: 10px; font-family: 'Consolas', monospace; font-size: 14px; resize: none; outline: none; }
        #output { height: 30%; background: #000; color: #0f0; padding: 10px; font-family: 'Consolas', monospace; overflow-y: auto; border-top: 1px solid #444; margin-top: 10px; }
        .run-btn { background: #007acc; margin-top: 10px; width: 100%; }
        
        /* è¼‰å…¥é®ç½© */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; justify-content:center; align-items:center; z-index:999; }
    </style>
</head>
<body onload="brython()">

    <div id="loading">æ­£åœ¨å¾ Google Sheets è®€å–é€²åº¦...</div>

    <div class="container">
        <div class="column left">
            <h2>ğŸ“š å­¸ç¿’å¤§ç¶±</h2>
            <div id="outline-container"></div>
        </div>

        <div class="column center">
            <h2>ğŸ’¡ å¿ƒå¾— & AI åŠ©æ•™</h2>
            
            <div id="chat-box" class="chat-box">
                <div class="ai-msg">å—¨ï¼é¸æ“‡å·¦é‚Šçš„ä¸»é¡Œé–‹å§‹å­¸ç¿’ï¼Œæœ‰å•é¡Œå¯ä»¥åœ¨é€™è£¡å•æˆ‘ã€‚</div>
            </div>
            
            <div style="display:flex; gap:5px; margin-bottom: 10px;">
                <input type="text" id="ai-input" style="flex:1; padding:8px;" placeholder="è©¢å• AI...">
                <button class="btn" onclick="askAI()" style="background:#2196F3;">ç™¼é€</button>
            </div>

            <hr style="width:100%; border:0; border-top:1px solid #ddd; margin: 10px 0;">
            
            <label for="note-input"><b>ğŸ“ æœ¬ç¯€å¿ƒå¾— (è‡ªå‹•å„²å­˜)</b></label>
            <textarea id="note-input" class="note-area" placeholder="é»é¸å·¦å´ä¸»é¡Œå¾Œï¼Œåœ¨æ­¤è¼¸å…¥å¿ƒå¾—..."></textarea>
            <button class="btn" onclick="saveCurrentNote()">å„²å­˜å¿ƒå¾—è‡³ Sheets</button>
        </div>

        <div class="column right">
            <h2>ğŸ Python ç·¨è­¯å™¨</h2>
            <textarea id="editor"># åœ¨é€™è£¡è¼¸å…¥ Python ä»£ç¢¼
print("Hello, World!")
for i in range(3):
    print(i)
</textarea>
            <button class="btn run-btn" id="run-btn">â–¶ åŸ·è¡Œç¨‹å¼ç¢¼</button>
            <pre id="output">åŸ·è¡Œçµæœå°‡é¡¯ç¤ºæ–¼æ­¤...</pre>
        </div>
    </div>

    <script type="text/javascript">
        // ================= é…ç½®å€ =================
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzQA5YJl5evebEhDCDWWdnDjcDAhJhw5UsLv0rfhkBaqCoWFmRkTHAgdWoHj7mFWBHB/exec"; 
        // =========================================

        let learningData = [];
        let currentTopicId = null;

        // åˆå§‹åŒ–ï¼šè®€å–è³‡æ–™
        window.addEventListener('DOMContentLoaded', () => {
            fetch(GAS_URL)
                .then(res => res.json())
                .then(data => {
                    learningData = data;
                    renderOutline();
                    document.getElementById('loading').style.display = 'none';
                })
                .catch(err => {
                    alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ GAS éƒ¨ç½²æ¬Šé™");
                    console.error(err);
                });
        });

        // æ¸²æŸ“å·¦å´å¤§ç¶±
        function renderOutline() {
            const container = document.getElementById('outline-container');
            container.innerHTML = '';
            
            let currentSection = '';
            learningData.forEach(item => {
                // å¦‚æœæ˜¯æ–°ç« ç¯€ï¼ŒåŠ å…¥æ¨™é¡Œ
                if (item.section !== currentSection) {
                    const sectionTitle = document.createElement('div');
                    sectionTitle.className = 'chapter';
                    sectionTitle.innerText = item.section;
                    container.appendChild(sectionTitle);
                    currentSection = item.section;
                }

                // å»ºç«‹ç´°é …
                const div = document.createElement('div');
                div.className = 'topic-item';
                div.onclick = (e) => {
                    if(e.target.type !== 'checkbox') selectTopic(item.id);
                };

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = item.done;
                checkbox.onclick = (e) => toggleDone(item.id, e.target.checked);

                const span = document.createElement('span');
                span.innerText = item.topic;

                div.appendChild(checkbox);
                div.appendChild(span);
                container.appendChild(div);
            });
        }

        // é¸æ“‡ä¸»é¡Œ
        function selectTopic(id) {
            currentTopicId = id;
            const item = learningData.find(d => d.id === id);
            
            // æ›´æ–° UI é¡¯ç¤º
            document.querySelectorAll('.topic-item').forEach(el => el.classList.remove('active'));
            // ç°¡å–®è™•ç† active æ¨£å¼ (å¯¦éš›æ‡‰ç”¨å¯å„ªåŒ–)
            
            // è¼‰å…¥å¿ƒå¾—
            document.getElementById('note-input').value = item.note || "";
            
            // æç¤º
            document.getElementById('chat-box').innerHTML += `<div class="ai-msg">ä½ åˆ‡æ›åˆ°äº†ï¼š${item.topic}ã€‚æœ‰ä»€éº¼å•é¡Œå—ï¼Ÿ</div>`;
        }

        // åˆ‡æ›å®Œæˆç‹€æ…‹ (åŒæ­¥åˆ° GAS)
        function toggleDone(id, isDone) {
            // æ›´æ–°æœ¬åœ°è³‡æ–™
            const item = learningData.find(d => d.id === id);
            item.done = isDone;

            // ç™¼é€åˆ° GAS
            fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors', // é‡è¦ï¼šé¿å… CORS éŒ¯èª¤ï¼Œä½†ç„¡æ³•è®€å–å›å‚³å€¼
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'toggle', id: id, done: isDone })
            }).then(() => console.log("Updated checkbox"));
        }

        // å„²å­˜å¿ƒå¾— (åŒæ­¥åˆ° GAS)
        function saveCurrentNote() {
            if (!currentTopicId) return alert("è«‹å…ˆé¸æ“‡ä¸€å€‹ä¸»é¡Œï¼");
            
            const content = document.getElementById('note-input').value;
            const item = learningData.find(d => d.id === currentTopicId);
            item.note = content;

            const btn = document.querySelector('button[onclick="saveCurrentNote()"]');
            const originalText = btn.innerText;
            btn.innerText = "å„²å­˜ä¸­...";

            fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'save_note', id: currentTopicId, note: content })
            }).then(() => {
                btn.innerText = originalText;
                alert("å¿ƒå¾—å·²å„²å­˜ï¼");
            });
        }

        // æ¨¡æ“¬ AI å›æ‡‰ (å› ç‚ºæ²’æ¥çœŸå¯¦ API Key)
        function askAI() {
            const input = document.getElementById('ai-input');
            const chatBox = document.getElementById('chat-box');
            const text = input.value;
            if(!text) return;

            // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
            chatBox.innerHTML += `<div class="user-msg">${text}</div>`;
            input.value = '';

            // æ¨¡æ“¬ AI æ€è€ƒèˆ‡å›æ‡‰
            setTimeout(() => {
                // é€™è£¡å¯ä»¥æ›æˆ fetch OpenAI API
                const reply = `(AI æ¨¡æ“¬å›æ‡‰): é—œæ–¼ "${text}"ï¼Œä½ å¯ä»¥å˜—è©¦ print() çœ‹çœ‹çµæœã€‚`; 
                chatBox.innerHTML += `<div class="ai-msg">${reply}</div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            }, 1000);
        }
    </script>

    <script type="text/python">
        from browser import document, alert
        import sys

        # é‡å° stdout åˆ°ç¶²é ä¸Šçš„ div
        class Output:
            def write(self, *args):
                document["output"].text += args[0]
            def flush(self):
                pass

        sys.stdout = Output()
        sys.stderr = Output()

        def run_code(ev):
            document["output"].text = "" # æ¸…ç©ºèˆŠè¼¸å‡º
            code = document["editor"].value
            try:
                exec(code)
            except Exception as e:
                print(f"Error: {e}")

        document["run-btn"].bind("click", run_code)
    </script>

</body>
</html>
