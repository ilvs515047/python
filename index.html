<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python è‡ªå­¸ç³»çµ± (Gemini 2.5)</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.11.0/brython.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.11.0/brython_stdlib.js"></script>
    <style>
        /* ç°¡å–®æ¸…çˆ½çš„ CSS è¨­å®š */
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; }
        .container { display: flex; height: 100vh; }
        
        /* ä¸‰æ¬„ä½ˆå±€ */
        .col { padding: 20px; box-sizing: border-box; border-right: 1px solid #ddd; overflow-y: auto; display: flex; flex-direction: column; }
        .col-left { width: 25%; background: #fff; }
        .col-center { width: 35%; background: #fafafa; }
        .col-right { width: 40%; background: #1e1e1e; color: #d4d4d4; padding: 0; }

        h2 { font-size: 1.1rem; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-top: 0; }

        /* å·¦å´ï¼šå¤§ç¶±åˆ—è¡¨ */
        .section-title { font-weight: bold; margin-top: 15px; color: #7f8c8d; font-size: 0.9rem; }
        .topic-item { display: flex; align-items: center; padding: 10px; cursor: pointer; border-radius: 5px; margin: 5px 0; transition: 0.2s; }
        .topic-item:hover { background: #ecf0f1; }
        .topic-item.active { background: #d6eaf8; font-weight: bold; border-left: 4px solid #3498db; }
        .topic-item input[type="checkbox"] { margin-right: 10px; transform: scale(1.2); cursor: pointer; }

        /* ä¸­é–“ï¼šèŠå¤©èˆ‡ç­†è¨˜ */
        .chat-container { flex: 1; border: 1px solid #e0e0e0; background: #fff; border-radius: 8px; padding: 15px; overflow-y: auto; margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 10px; max-width: 80%; line-height: 1.5; font-size: 0.95rem; }
        .msg.ai { background: #e8f6f3; align-self: flex-start; border-bottom-left-radius: 0; color: #333; }
        .msg.user { background: #d6eaf8; align-self: flex-end; border-bottom-right-radius: 0; color: #000; }
        
        .input-area { display: flex; gap: 5px; margin-bottom: 20px; }
        .input-area input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; outline: none; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-send { background: #3498db; color: white; }
        .btn-save { background: #27ae60; color: white; margin-top: 5px; width: 100%; }
        .btn-run { background: #f1c40f; color: #333; width: 100%; padding: 15px; font-size: 1rem; }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        textarea.note-box { width: 100%; height: 120px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; resize: vertical; box-sizing: border-box; }

        /* å³å´ï¼šç·¨è­¯å™¨ */
        #editor { flex: 1; width: 100%; background: #252526; color: #d4d4d4; border: none; padding: 15px; font-family: 'Consolas', 'Courier New', monospace; font-size: 14px; outline: none; resize: none; box-sizing: border-box; }
        #output { height: 30%; background: #000; color: #00ff00; padding: 15px; font-family: 'Consolas', monospace; overflow-y: auto; box-sizing: border-box; margin: 0; border-top: 1px solid #333; white-space: pre-wrap; }

        /* è¼‰å…¥é®ç½© */
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 1000; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; color: #555; }
    </style>
</head>
<body onload="brython()">

    <div id="loading-overlay">æ­£åœ¨è®€å–å­¸ç¿’é€²åº¦...</div>

    <div class="container">
        <div class="col col-left">
            <h2>ğŸ“š å­¸ç¿’åœ°åœ–</h2>
            <div id="outline-list"></div>
        </div>

        <div class="col col-center">
            <h2>ğŸ¤– AI åŠ©æ•™ (Gemini 2.5)</h2>
            <div class="chat-container" id="chat-box">
                <div class="msg ai">ä½ å¥½ï¼æˆ‘æ˜¯ Python å­¸ç¿’åŠ©æ•™ã€‚é¸æ“‡å·¦é‚Šçš„ä¸»é¡Œï¼Œæˆ‘å€‘å¯ä»¥é–‹å§‹è¨è«–ï¼Œæˆ–è€…ç›´æ¥åœ¨ä¸‹æ–¹å•æˆ‘ç¨‹å¼å•é¡Œã€‚</div>
            </div>
            <div class="input-area">
                <input type="text" id="ai-input" placeholder="å•å• AI (ä¾‹å¦‚: è¿´åœˆæ€éº¼å¯«?)..." onkeypress="handleKeyPress(event)">
                <button class="btn btn-send" onclick="askAI()" id="btn-ask">ç™¼é€</button>
            </div>

            <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">

            <h2>ğŸ“ å­¸ç¿’å¿ƒå¾—</h2>
            <textarea id="note-input" class="note-box" placeholder="é»é¸å·¦å´ä¸»é¡Œå¾Œï¼Œåœ¨æ­¤è¨˜éŒ„å¿ƒå¾—..."></textarea>
            <button class="btn btn-save" onclick="saveNote()" id="btn-save-note">å„²å­˜å¿ƒå¾—</button>
        </div>

        <div class="col col-right">
            <textarea id="editor"># Python ç·´ç¿’å€
print("Hello, Python!")

for i in range(5):
    print("æ•¸åˆ°:", i)
</textarea>
            <button class="btn btn-run" id="run-btn">â–¶ åŸ·è¡Œç¨‹å¼ç¢¼ (Run)</button>
            <pre id="output">åŸ·è¡Œçµæœå°‡é¡¯ç¤ºæ–¼æ­¤...</pre>
        </div>
    </div>

    <script>
        // ============================================
        // è¨­å®šå€ï¼šè«‹å°‡ä¸‹æ–¹çš„ç¶²å€æ›æˆæ‚¨çš„ Web App URL
        // ============================================
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzQA5YJl5evebEhDCDWWdnDjcDAhJhw5UsLv0rfhkBaqCoWFmRkTHAgdWoHj7mFWBHB/exec"; 
        // ============================================

        let learningData = [];
        let currentTopicId = null;

        // 1. åˆå§‹åŒ–ï¼šè¼‰å…¥è³‡æ–™
        window.addEventListener('DOMContentLoaded', () => {
            if (GAS_URL.includes("æ‚¨çš„_GAS")) {
                alert("è«‹è¨˜å¾—ä¿®æ”¹ index.html ä¸­çš„ GAS_URL è®Šæ•¸ï¼");
                document.getElementById('loading-overlay').style.display = 'none';
                return;
            }
            fetchData();
        });

        function fetchData() {
            fetch(GAS_URL)
                .then(res => res.json())
                .then(data => {
                    learningData = data;
                    renderList();
                    document.getElementById('loading-overlay').style.display = 'none';
                })
                .catch(err => {
                    console.error(err);
                    alert("è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– GAS éƒ¨ç½²è¨­å®šã€‚");
                    document.getElementById('loading-overlay').innerText = "è®€å–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†ã€‚";
                });
        }

        // 2. æ¸²æŸ“å·¦å´åˆ—è¡¨
        function renderList() {
            const listDiv = document.getElementById('outline-list');
            listDiv.innerHTML = '';
            
            let currentSec = '';
            learningData.forEach(item => {
                // åŠ å…¥ç« ç¯€æ¨™é¡Œ
                if (item.section !== currentSec) {
                    const secTitle = document.createElement('div');
                    secTitle.className = 'section-title';
                    secTitle.innerText = item.section;
                    listDiv.appendChild(secTitle);
                    currentSec = item.section;
                }

                // åŠ å…¥ç´°é …
                const row = document.createElement('div');
                row.className = 'topic-item';
                row.dataset.id = item.id;
                
                // é»æ“Šæ•´è¡Œåˆ‡æ›ç­†è¨˜ (é™¤äº† Checkbox)
                row.onclick = (e) => {
                    if (e.target.type !== 'checkbox') selectTopic(item.id);
                };

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = item.done;
                checkbox.onclick = (e) => toggleDone(item.id, e.target.checked);

                const text = document.createElement('span');
                text.innerText = item.topic;

                row.appendChild(checkbox);
                row.appendChild(text);
                listDiv.appendChild(row);
            });
        }

        // 3. é¸æ“‡ä¸»é¡Œ
        function selectTopic(id) {
            currentTopicId = id;
            
            // UI æ›´æ–°
            document.querySelectorAll('.topic-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.topic-item[data-id='${id}']`).classList.add('active');

            // è¼‰å…¥ç­†è¨˜
            const item = learningData.find(d => d.id == id);
            document.getElementById('note-input').value = item.note || "";
            
            // æç¤º AI
            // document.getElementById('chat-box').innerHTML += `<div class="msg ai">ä½ åˆ‡æ›åˆ°äº†ä¸»é¡Œï¼šã€Œ${item.topic}ã€ã€‚æœ‰ä»€éº¼å•é¡Œå—ï¼Ÿ</div>`;
        }

        // 4. æ‰“å‹¾å®Œæˆ
        function toggleDone(id, isDone) {
            const item = learningData.find(d => d.id == id);
            item.done = isDone;

            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // é¿å… CORS preflight
                body: JSON.stringify({ action: 'toggle', id: id, done: isDone })
            });
        }

        // 5. å„²å­˜ç­†è¨˜
        function saveNote() {
            if (!currentTopicId) return alert("è«‹å…ˆå¾å·¦å´é¸æ“‡ä¸€å€‹ä¸»é¡Œï¼");
            
            const note = document.getElementById('note-input').value;
            const btn = document.getElementById('btn-save-note');
            
            btn.innerText = "å„²å­˜ä¸­...";
            btn.disabled = true;

            // æ›´æ–°æœ¬åœ°æ•¸æ“š
            const item = learningData.find(d => d.id == currentTopicId);
            item.note = note;

            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'save_note', id: currentTopicId, note: note })
            })
            .then(res => res.json())
            .then(data => {
                btn.innerText = "å„²å­˜å¿ƒå¾—";
                btn.disabled = false;
                if(data.status !== 'success') alert("å„²å­˜å¤±æ•—");
            });
        }

        // 6. AI äº’å‹•
        function handleKeyPress(e) {
            if (e.key === 'Enter') askAI();
        }

        function askAI() {
            const input = document.getElementById('ai-input');
            const chatBox = document.getElementById('chat-box');
            const btn = document.getElementById('btn-ask');
            const text = input.value.trim();
            
            if (!text) return;

            // é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
            chatBox.innerHTML += `<div class="msg user">${text}</div>`;
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            // é–å®šæŒ‰éˆ•
            btn.disabled = true;
            btn.innerText = "æ€è€ƒä¸­...";
            
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'msg ai';
            loadingMsg.innerText = "Gemini 2.5 æ­£åœ¨æ€è€ƒ...";
            chatBox.appendChild(loadingMsg);

            // ç™¼é€è«‹æ±‚
            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'ask_ai', message: text })
            })
            .then(res => res.json())
            .then(data => {
                chatBox.removeChild(loadingMsg);
                // è™•ç†æ›è¡Œ
                const reply = data.reply.replace(/\n/g, '<br>');
                chatBox.innerHTML += `<div class="msg ai">${reply}</div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            })
            .catch(err => {
                chatBox.removeChild(loadingMsg);
                chatBox.innerHTML += `<div class="msg ai" style="color:red">é€£ç·šéŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚</div>`;
                console.error(err);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerText = "ç™¼é€";
            });
        }
    </script>

    <script type="text/python">
        from browser import document, alert
        import sys

        # è‡ªå®šç¾©è¼¸å‡ºé¡åˆ¥ï¼Œå°‡ stdout è½‰å‘åˆ°ç¶²é ä¸Šçš„ div
        class Output:
            def write(self, *args):
                document["output"].text += args[0]
                # è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
                document["output"].scrollTop = document["output"].scrollHeight
            def flush(self):
                pass

        sys.stdout = Output()
        sys.stderr = Output()

        def run_code(ev):
            document["output"].text = "=== åŸ·è¡Œé–‹å§‹ ===\n" 
            user_code = document["editor"].value
            try:
                exec(user_code)
            except Exception as e:
                print(f"\néŒ¯èª¤: {e}")
            print("\n=== åŸ·è¡ŒçµæŸ ===")

        document["run-btn"].bind("click", run_code)
    </script>
</body>
</html>
